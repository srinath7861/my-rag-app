<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Chat</title>
  <style>
    :root { --primary: #4f46e5; --primary-hover: #4338ca; --bg: #f8fafc; --card: #fff; --text: #1e293b; --muted: #64748b; --border: #e2e8f0; --radius: 10px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; background: var(--bg); color: var(--text); }
    .app { max-width: 900px; margin: 0 auto; }
    .api-row { margin-bottom: 1rem; }
    .api-row input { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; }
    nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border); }
    nav a { padding: 0.6rem 1rem; color: var(--muted); text-decoration: none; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    nav a:hover, nav a.active { color: var(--primary); border-bottom-color: var(--primary); }
    .panel { display: none; }
    .panel.active { display: block; }

    /* Chat conversation */
    .chat-container { background: var(--card); border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; min-height: 420px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 1rem; min-height: 320px; }
    .msg { max-width: 85%; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.5; }
    .msg.user { margin-left: auto; background: var(--primary); color: #fff; }
    .msg.assistant { background: #f1f5f9; }
    .msg .sources { font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem; }
    .chat-form { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--border); }
    .chat-form input { flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; }
    .chat-form button { padding: 0.75rem 1.25rem; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .chat-form button:hover { background: var(--primary-hover); }
    .chat-form button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Knowledge base sections */
    .kb-section { margin-bottom: 2rem; padding: 1.25rem; background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); }
    .kb-section h3 { margin: 0 0 1rem 0; font-size: 1rem; }
    .kb-list { list-style: none; padding: 0; margin: 0; }
    .kb-item { padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; }
    .kb-item-content { flex: 1; min-width: 0; }
    .kb-item-content .url-link { font-size: 0.85rem; color: var(--primary); word-break: break-all; }
    .kb-item-content .preview { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; max-height: 60px; overflow: hidden; text-overflow: ellipsis; }
    .kb-item-actions { display: flex; gap: 0.25rem; }
    .kb-item-actions button { padding: 0.35rem 0.6rem; font-size: 0.8rem; border: 1px solid var(--border); background: #fff; border-radius: 6px; cursor: pointer; }
    .kb-item-actions button.danger { color: #dc2626; border-color: #fecaca; }
    .kb-item-actions button.danger:hover { background: #fef2f2; }
    .add-form { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .add-form input, .add-form textarea { flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; }
    .add-form textarea { min-height: 60px; resize: vertical; }
    button.primary { background: var(--primary); color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
    button.primary:hover { background: var(--primary-hover); }
    .status { font-size: 0.85rem; margin-top: 0.5rem; }
    .status.error { color: #dc2626; }
    .status.success { color: #16a34a; }
    #knowledgeEditor { width: 100%; min-height: 180px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; resize: vertical; }
    .sub-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .sub-nav button { padding: 0.4rem 0.8rem; border: 1px solid var(--border); background: #fff; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .sub-nav button.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .qna-pair { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .qna-pair strong { font-size: 0.85rem; }
    button.danger { color: #dc2626; border: 1px solid #fecaca; background: #fff; border-radius: 6px; padding: 0.4rem 0.8rem; cursor: pointer; }
    button.danger:hover { background: #fef2f2; }
  </style>
</head>
<body>
<div class="app">
  <div class="api-row"><label>API:</label><input type="text" id="apiBase" value="http://localhost:8000" /></div>
  <nav>
    <a href="#" id="navChat" class="active">Chat</a>
    <a href="#" id="navKB">Knowledge base</a>
  </nav>

  <div id="panelChat" class="panel active">
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages"></div>
      <form class="chat-form" id="chatForm">
        <input type="text" id="chatInput" placeholder="Ask anything..." autocomplete="off" />
        <button type="submit" id="chatSubmit">Send</button>
      </form>
    </div>
  </div>

  <div id="panelKB" class="panel">
    <div class="sub-nav">
      <button type="button" data-tab="main" class="kb-tab active">Main text</button>
      <button type="button" data-tab="urls" class="kb-tab">URLs</button>
      <button type="button" data-tab="docs" class="kb-tab">Documents</button>
      <button type="button" data-tab="qna" class="kb-tab">Q&A</button>
    </div>

    <div id="kbMain" class="kb-tab-panel">
      <div class="kb-section">
        <h3>Knowledge base text</h3>
        <textarea id="knowledgeEditor" placeholder="Main knowledge content..."></textarea>
        <div style="margin-top: 0.75rem;"><button type="button" id="saveBtn" class="primary">Save</button><span id="saveStatus" class="status"></span></div>
      </div>
    </div>

    <div id="kbUrls" class="kb-tab-panel" style="display:none;">
      <div class="kb-section">
        <h3>Add URL</h3>
        <form id="urlForm" class="add-form">
          <input type="url" id="urlInput" placeholder="https://example.com" />
          <button type="submit" class="primary">Add URL</button>
        </form>
        <span id="urlStatus" class="status"></span>
        <h3 style="margin-top: 1.5rem;">URLs in knowledge base</h3>
        <ul class="kb-list" id="urlList"></ul>
      </div>
    </div>

    <div id="kbDocs" class="kb-tab-panel" style="display:none;">
      <div class="kb-section">
        <h3>Add document</h3>
        <form id="docForm" class="add-form">
          <input type="text" id="docName" placeholder="Document name" />
          <textarea id="docContent" placeholder="Content..."></textarea>
          <button type="submit" class="primary">Add document</button>
        </form>
        <span id="docStatus" class="status"></span>
        <h3 style="margin-top: 1.5rem;">Documents</h3>
        <ul class="kb-list" id="docList"></ul>
      </div>
    </div>

    <div id="kbQna" class="kb-tab-panel" style="display:none;">
      <div class="kb-section">
        <h3>Add Q&A pair</h3>
        <form id="qnaForm" class="add-form">
          <input type="text" id="qnaQuestion" placeholder="Short question" />
          <input type="text" id="qnaAnswer" placeholder="Short answer" />
          <button type="submit" class="primary">Add Q&A</button>
        </form>
        <span id="qnaStatus" class="status"></span>
        <div style="margin-top: 1rem;"><button type="button" id="qnaClear" class="danger" style="padding:0.4rem 0.8rem;border-radius:6px;">Clear all Q&A</button></div>
        <h3 style="margin-top: 1.5rem;">Q&A pairs</h3>
        <div id="qnaList"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const apiBaseEl = document.getElementById('apiBase');
  function getBase() {
    let b = apiBaseEl.value.trim();
    return (b || 'http://localhost:8000').replace(/\/$/, '');
  }

  const messages = [];
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatSubmit = document.getElementById('chatSubmit');

  function addMessage(role, text, sources) {
    messages.push({ role, text, sources });
    const div = document.createElement('div');
    div.className = 'msg ' + role;
    div.innerHTML = '<div>' + escapeHtml(text) + '</div>' + (sources && sources.length ? '<div class="sources">Sources: ' + sources.map(s => escapeHtml(s.source || '')).join(', ') + '</div>' : '');
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = chatInput.value.trim();
    if (!q) return;
    addMessage('user', q);
    chatInput.value = '';
    chatSubmit.disabled = true;
    try {
      const res = await fetch(getBase() + '/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: q }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || res.statusText);
      addMessage('assistant', data.answer || 'No answer.', data.sources || []);
    } catch (err) {
      addMessage('assistant', 'Error: ' + (err.message || String(err)), []);
    } finally {
      chatSubmit.disabled = false;
    }
  });

  const navChat = document.getElementById('navChat');
  const navKB = document.getElementById('navKB');
  const panelChat = document.getElementById('panelChat');
  const panelKB = document.getElementById('panelKB');
  navChat.addEventListener('click', (e) => { e.preventDefault(); panelChat.classList.add('active'); panelKB.classList.remove('active'); navChat.classList.add('active'); navKB.classList.remove('active'); });
  navKB.addEventListener('click', (e) => { e.preventDefault(); panelChat.classList.remove('active'); panelKB.classList.add('active'); navChat.classList.remove('active'); navKB.classList.add('active'); loadKB(); });

  document.querySelectorAll('.kb-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.kb-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.kb-tab-panel').forEach(p => p.style.display = 'none');
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab');
      const panel = document.getElementById('kb' + tab.charAt(0).toUpperCase() + tab.slice(1));
      if (panel) panel.style.display = 'block';
      if (tab === 'main') loadKnowledge();
      if (tab === 'urls') loadUrls();
      if (tab === 'docs') loadDocs();
      if (tab === 'qna') loadQna();
    });
  });

  async function loadKnowledge() {
    try {
      const res = await fetch(getBase() + '/knowledge');
      const data = await res.json();
      document.getElementById('knowledgeEditor').value = data.content != null ? data.content : '';
      document.getElementById('saveStatus').textContent = '';
    } catch (e) {
      document.getElementById('saveStatus').textContent = 'Error: ' + (e.message || e);
      document.getElementById('saveStatus').className = 'status error';
    }
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    const status = document.getElementById('saveStatus');
    status.textContent = 'Saving...';
    status.className = 'status';
    try {
      const res = await fetch(getBase() + '/knowledge', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: document.getElementById('knowledgeEditor').value }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || res.statusText);
      status.textContent = (data.message || 'Saved.') + ' Chunks: ' + (data.chunks_added ?? 0);
      status.className = 'status success';
    } catch (e) {
      status.textContent = 'Error: ' + (e.message || e);
      status.className = 'status error';
    }
  });

  document.getElementById('urlForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return;
    const status = document.getElementById('urlStatus');
    status.textContent = 'Fetching...';
    status.className = 'status';
    try {
      const res = await fetch(getBase() + '/ingest/url', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || res.statusText);
      status.textContent = (data.message || 'Added.') + ' Chunks: ' + (data.chunks_added ?? 0);
      status.className = 'status success';
      document.getElementById('urlInput').value = '';
      loadUrls();
    } catch (err) {
      status.textContent = 'Error: ' + (err.message || err);
      status.className = 'status error';
    }
  });

  async function loadUrls() {
    const list = document.getElementById('urlList');
    list.innerHTML = '';
    try {
      const res = await fetch(getBase() + '/urls');
      const data = await res.json();
      const urls = data.urls || [];
      urls.forEach(u => {
        const li = document.createElement('li');
        li.className = 'kb-item';
        const preview = (u.content || '').slice(0, 120) + (u.content && u.content.length > 120 ? '...' : '');
        li.innerHTML = '<div class="kb-item-content"><div class="url-link">' + escapeHtml(u.url) + '</div><div class="preview">' + escapeHtml(preview) + '</div></div><div class="kb-item-actions"><button type="button" class="edit-url" data-url="' + escapeHtml(u.url) + '">Edit</button><button type="button" class="danger delete-url" data-url="' + escapeHtml(u.url) + '">Delete</button></div>';
        list.appendChild(li);
      });
      list.querySelectorAll('.delete-url').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Remove this URL from the knowledge base?')) return;
          try {
            await fetch(getBase() + '/urls?url=' + encodeURIComponent(btn.getAttribute('data-url')), { method: 'DELETE' });
            loadUrls();
          } catch (e) { alert(e.message || e); }
        });
      });
      list.querySelectorAll('.edit-url').forEach(btn => {
        btn.addEventListener('click', () => {
          const url = btn.getAttribute('data-url');
          const u = (data.urls || []).find(x => x.url === url);
          const wrap = document.createElement('div');
          wrap.className = 'kb-section';
          wrap.style.marginTop = '0.5rem';
          wrap.innerHTML = '<h4>Edit URL content</h4><div class="url-link" style="margin-bottom:0.5rem;">' + escapeHtml(url) + '</div><textarea class="edit-url-content" placeholder="Extracted content" style="width:100%;min-height:120px;padding:0.5rem;">' + escapeHtml(u ? (u.content || '') : '') + '</textarea><div style="margin-top:0.5rem;"><button type="button" class="primary save-url-edit">Save</button> <button type="button" class="cancel-url-edit">Cancel</button></div>';
          btn.closest('.kb-item').after(wrap);
          wrap.querySelector('.save-url-edit').addEventListener('click', async () => {
            const content = wrap.querySelector('.edit-url-content').value;
            try {
              await fetch(getBase() + '/urls', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url, content }) });
              wrap.remove();
              loadUrls();
            } catch (e) { alert(e.message || e); }
          });
          wrap.querySelector('.cancel-url-edit').addEventListener('click', () => wrap.remove());
        });
      });
    } catch (e) {
      list.innerHTML = '<li class="kb-item">Error loading URLs.</li>';
    }
  }

  async function loadDocs() {
    const list = document.getElementById('docList');
    list.innerHTML = '';
    try {
      const res = await fetch(getBase() + '/documents');
      const data = await res.json();
      const docs = data.documents || [];
      docs.forEach(d => {
        const li = document.createElement('li');
        li.className = 'kb-item';
        li.innerHTML = '<div class="kb-item-content">' + escapeHtml(d.name || d.id) + '</div><div class="kb-item-actions"><button type="button" class="edit-doc" data-id="' + escapeHtml(d.id) + '">Edit</button><button type="button" class="danger delete-doc" data-id="' + escapeHtml(d.id) + '">Delete</button></div>';
        list.appendChild(li);
      });
      list.querySelectorAll('.delete-doc').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Delete this document?')) return;
          try {
            await fetch(getBase() + '/documents/' + encodeURIComponent(btn.getAttribute('data-id')), { method: 'DELETE' });
            loadDocs();
          } catch (e) { alert(e.message || e); }
        });
      });
      list.querySelectorAll('.edit-doc').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const r = await fetch(getBase() + '/documents/' + encodeURIComponent(id));
          const d = await r.json();
          const wrap = document.createElement('div');
          wrap.className = 'kb-section';
          wrap.style.marginTop = '0.5rem';
          wrap.innerHTML = '<h4>Edit document</h4><input type="text" class="edit-doc-name" placeholder="Name" value="' + escapeHtml(d.id) + '" style="width:100%;margin-bottom:0.5rem;padding:0.5rem;"><textarea class="edit-doc-content" placeholder="Content" style="width:100%;min-height:120px;padding:0.5rem;">' + escapeHtml(d.content || '') + '</textarea><div style="margin-top:0.5rem;"><button type="button" class="primary save-doc-edit">Save</button> <button type="button" class="cancel-doc-edit">Cancel</button></div>';
          const li = btn.closest('.kb-item');
          li.after(wrap);
          wrap.querySelector('.save-doc-edit').addEventListener('click', async () => {
            const name = wrap.querySelector('.edit-doc-name').value.trim() || id;
            const content = wrap.querySelector('.edit-doc-content').value;
            try {
              await fetch(getBase() + '/documents/' + encodeURIComponent(id), { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, content }) });
              wrap.remove();
              loadDocs();
            } catch (e) { alert(e.message || e); }
          });
          wrap.querySelector('.cancel-doc-edit').addEventListener('click', () => wrap.remove());
        });
      });
    } catch (e) {
      list.innerHTML = '<li class="kb-item">Error loading documents.</li>';
    }
  }

  document.getElementById('docForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('docName').value.trim() || 'Untitled';
    const content = document.getElementById('docContent').value.trim();
    const status = document.getElementById('docStatus');
    try {
      const res = await fetch(getBase() + '/documents', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, content }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || res.statusText);
      status.textContent = (data.message || 'Added.') + ' Chunks: ' + (data.chunks_added ?? 0);
      status.className = 'status success';
      document.getElementById('docName').value = '';
      document.getElementById('docContent').value = '';
      loadDocs();
    } catch (err) {
      status.textContent = 'Error: ' + (err.message || err);
      status.className = 'status error';
    }
  });

  async function loadQna() {
    const list = document.getElementById('qnaList');
    list.innerHTML = '';
    try {
      const res = await fetch(getBase() + '/qna');
      const data = await res.json();
      const qna = data.qna || [];
      qna.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'qna-pair';
        div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;"><div><strong>Q:</strong> ' + escapeHtml(p.question) + '<br><strong>A:</strong> ' + escapeHtml(p.answer) + '</div><button type="button" class="danger delete-qna-one" data-index="' + i + '" style="flex-shrink:0;">Delete</button></div>';
        list.appendChild(div);
      });
      list.querySelectorAll('.delete-qna-one').forEach(btn => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.getAttribute('data-index'), 10);
          if (isNaN(idx)) return;
          try {
            const r = await fetch(getBase() + '/qna/' + idx, { method: 'DELETE' });
            if (!r.ok) throw new Error((await r.json()).detail || r.statusText);
            loadQna();
          } catch (e) { alert(e.message || e); }
        });
      });
    } catch (e) {
      list.innerHTML = '<div class="status error">Error loading Q&A.</div>';
    }
  }

  document.getElementById('qnaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const question = document.getElementById('qnaQuestion').value.trim();
    const answer = document.getElementById('qnaAnswer').value.trim();
    if (!question || !answer) return;
    const status = document.getElementById('qnaStatus');
    try {
      const res = await fetch(getBase() + '/qna', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question, answer }) });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || res.statusText);
      status.textContent = (data.message || 'Added.') + ' Chunks: ' + (data.chunks_added ?? 0);
      status.className = 'status success';
      document.getElementById('qnaQuestion').value = '';
      document.getElementById('qnaAnswer').value = '';
      loadQna();
    } catch (err) {
      status.textContent = 'Error: ' + (err.message || err);
      status.className = 'status error';
    }
  });

  document.getElementById('qnaClear').addEventListener('click', async () => {
    if (!confirm('Remove all Q&A from the knowledge base?')) return;
    try {
      await fetch(getBase() + '/qna', { method: 'DELETE' });
      loadQna();
      document.getElementById('qnaStatus').textContent = 'All Q&A removed.';
      document.getElementById('qnaStatus').className = 'status success';
    } catch (e) { alert(e.message || e); }
  });

  function loadKB() {
    loadKnowledge();
    const activeTab = document.querySelector('.kb-tab.active');
    if (activeTab) {
      const tab = activeTab.getAttribute('data-tab');
      if (tab === 'urls') loadUrls();
      if (tab === 'docs') loadDocs();
      if (tab === 'qna') loadQna();
    }
  }
})();
</script>
</body>
</html>
